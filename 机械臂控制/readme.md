## 使用Lite2外加机械臂抓取物体
### 实训背景

在机械狗上加装机械臂可以赋予机械狗更多的功能，更加充分的发挥四足机器人的灵活特性（balabal一大堆）

### 实训内容

该实训主要是学会使用串口控制总线舵机，设计总线机械臂的动作组

### 实训目的及要求

成功使用串口驱动机械臂

设计机械臂动作组以完成目标任务

调用机械臂上自带的摄像头进行识别

### 实验软硬件环境

- 硬件：绝影Lite2、小R科技总线舵机机械臂
- 软件：
	- python 3.7
	- opencv 4.7.0

### 实训操作指南
1. 机械臂简述
	- 机械臂组成
	机械臂主要由多个关节组成，每个关节由伺服电机驱动，通过协调这些关节运动实现末端执行器的精确定位。整个系统的硬件部分包括伺服电机、传感器和控制器。伺服电机负责驱动机械臂的关节，传感器用于检测机械臂的当前位置和姿态，而控制器则用于处理来自传感器的信号并生成相应的控制指令。
	- 机械臂控制算法
	控制算法采用简单的反向运动学算法，能够根据目标位置和姿态计算各关节的角度。软件部分负责实现这些算法，并通过通信接口与控制器进行数据交换。用户可以通过图形化界面输入目标位置，系统将自动计算路径并控制机械臂执行任务。
	- 机械臂通信协议
	通信部分使用串口通信协议，确保控制器和计算机之间的指令和反馈数据的可靠传输。整个控制流程包括初始化机械臂、接收目标位置、计算运动路径、发送控制指令、执行任务，以及在任务完成后返回初始位置。
	- 机械臂调试软件
	本款机械臂用到了飞特调试软件，首先将机械臂通电并将其连接在电脑USB口上，在软件中找到机械臂连接的端口并搜素6个舵机的ID号，将机械臂调整到需要的位置并通过软件依次读取6个舵机的位置编号。在机械臂控制算法中，可将不同动作的舵机位置编号填入，在主程序中调用，即可实现控制机械臂

2. 连接机械臂
	连接机械臂时，需要注意顺序，由于机械臂自带摄像头，且Jetson Xavier NX主板在启动时会优先加载USB设备，所以在先连接机械臂，然后再开机时，系统中摄像头的编号会发生变化。正常开机时，摄像头编号为`video0`(广角摄像头彩图)、`video1`(广角摄像头灰度图)、`video2`(深度摄像头深度图)、`video3`(深度摄像头灰度图)、`video4`(深度摄像头彩图)；加装机械臂后再开机时，以上设备编号各自加 1，变为`video1`至`video5`。这种情况对于编写其他代码会造成比较大的困扰，因此需要按照如下顺序加装机械臂
	1. 先将机械狗开机进入系统
	2. 在`terminal`输入`top`查看当前进程
	3. 使用`sudo kill -9 进程pid号`将上一步中查找到的python进程杀死
	4. 加装机械臂，连接机械臂USB线，将电源线接到12V输出口
	5. 使用`sudo chmod 777 /dev/ttyUSB0`为串口添加权限

	此时我们就可以操控机械臂了
	
3. 使用代码`wheel_arm.py`，即可简单控制机械臂

4. 我们可以进一步自定义机械臂姿态。在文件`utils/ArmController.py`中，可以看到六个舵机各自的ID号，在`def set_pose(self, mode = 0)`中可以修改每一个舵机的开合角度，配合飞特调试软件，即可实现将机械臂控制到自己想要的姿态

>```python
#舵机编号，抓手为1，底盘为6
SCS_ID_1 = 1  # SCServo ID : 1  抓手开合
SCS_ID_2 = 2  # SCServo ID : 2  抓收旋转
SCS_ID_3 = 3  # SCServo ID : 3  第三连杆
SCS_ID_4 = 4  # SCServo ID : 4  第二连杆
SCS_ID_5 = 5  # SCServo ID : 5  第一连杆
SCS_ID_6 = 6  # SCServo ID : 6  控制整个机械臂旋转
>```
>

5. 为了可以准确抓取物体，我们需要采取措施让机械狗知道物体的位置。可以采用aruco码进行简单定位，基本步骤如下
	1. 设置aruco码基本参数
	>```python
	arcode_mode = cv2.aruco.DICT_4X4_50  # 用于定位的ar码的规格
	marker_size = 10  # aruco码的实际尺寸是10厘米
	left_right_thr = 10  # 左右调整位置时，可容忍的偏差 [-thr, thr] 像素
	forward_thr = 30  # 直走时，目标偏差超过thr像素时，开始调整左右位置
	target_id = 1  # 目标ar码的值为多少
	ar_distance = 12 # 距离ar码多少cm时停下
	>```
	>
	2. 捕获视频流，进行相机校准后，使用`cv2.aruco.ArucoDetector()` 函数检测ArUco码的角点，通过`cv2.solvePnP`函数，估算每个ArUco码相对于相机的旋转向量 (rvec) 和平移向量 (tvec)，将这些向量转换为相机坐标系下的位置信息，并计算出每个ArUco码与相机之间的距离。
	3. 根据上一步中的计算结果，对机械狗执行对应操作。

6. 参考代码`chuangyiarm.py`为2024创意大赛四足专项附加赛内容
### 参考
https://github.com/Jadeble/sizutrain.git