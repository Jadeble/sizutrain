## 使用Lite2外加机械臂抓取物体
### 实训背景

四足机器人在多个领域有其独特的优势，特别是在复杂地形的移动性和灵活性方面。为了进一步拓展四足机器人的功能，增加其在实际应用中的价值，在机械狗上加装机械臂成为了一个重要的研究方向。机械臂的加装不仅能够增强机械狗的物体操作能力，如抓取、搬运、和精细操作等，还能让其在更多复杂任务中表现出色，如救援、探索、服务和人机交互等。通过结合机械臂和四足机器人的特性，能够最大限度地发挥机器人系统的潜力，使其在各种应用场景中更加得心应手。

### 实训内容

本次实训将重点放在学习和掌握如何通过串口控制总线舵机，以实现对机械臂的精确控制。学员将深入了解总线舵机的工作原理、通信协议以及串口通信的基础知识。在此基础上，学员将设计并实现一个完整的机械臂动作组，使机械臂能够执行一系列预定义的任务。除了动作设计，实训还涵盖了如何调用机械臂上集成的摄像头进行目标识别，以实现更高层次的自动化操作。通过摄像头的实时数据，机械臂可以在动态环境中做出相应的调整，从而提升任务的完成度和准确性。

### 实训目的及要求
#### 目的
- 掌握串口驱动技术：熟悉串口通信的基本原理和操作方法，能够使用串口接口驱动总线舵机，实现对机械臂的控制。
- 掌握调用机械臂自带摄像头的技巧，并进行基本的图像识别任务，使机械臂能够根据识别结果进行相应的操作。
- 设计并实现机械臂的动作组，以使机械臂能够完成指定的任务，提升对机械臂控制的实战经验。

#### 要求
- 通过串口和机械臂建立联系，并成功驱动机械臂
- 成功调用机械臂上的摄像头，实现简单的目标识别，并根据结果进行简单的自动化控制
- 设置合适的动作组，使机械臂在完成目标的同时，动作流畅

### 实验软硬件环境

- 硬件：绝影Lite2、小R科技总线舵机机械臂
- 软件：
	- python 3.7
	- opencv 4.7.0

### 实训操作指南
1. 机械臂简述
	- 机械臂组成
	机械臂主要由多个关节组成，每个关节由伺服电机驱动，通过协调这些关节运动实现末端执行器的精确定位。整个系统的硬件部分包括伺服电机、传感器和控制器。伺服电机负责驱动机械臂的关节，传感器用于检测机械臂的当前位置和姿态，而控制器则用于处理来自传感器的信号并生成相应的控制指令。
	- 机械臂控制算法
	控制算法采用简单的反向运动学算法，能够根据目标位置和姿态计算各关节的角度。软件部分负责实现这些算法，并通过通信接口与控制器进行数据交换。用户可以通过图形化界面输入目标位置，系统将自动计算路径并控制机械臂执行任务。
	- 机械臂通信协议
	通信部分使用串口通信协议，确保控制器和计算机之间的指令和反馈数据的可靠传输。整个控制流程包括初始化机械臂、接收目标位置、计算运动路径、发送控制指令、执行任务，以及在任务完成后返回初始位置。
	- 机械臂调试软件
	本款机械臂用到了飞特调试软件，首先将机械臂通电并将其连接在电脑USB口上，在软件中找到机械臂连接的端口并搜素6个舵机的ID号，将机械臂调整到需要的位置并通过软件依次读取6个舵机的位置编号。在机械臂控制算法中，可将不同动作的舵机位置编号填入，在主程序中调用，即可实现控制机械臂

2. 连接机械臂
	连接机械臂时，需要注意顺序，由于机械臂自带摄像头，且Jetson Xavier NX主板在启动时会优先加载USB设备，所以在先连接机械臂，然后再开机时，系统中摄像头的编号会发生变化。正常开机时，摄像头编号为`video0`(广角摄像头彩图)、`video1`(广角摄像头灰度图)、`video2`(深度摄像头深度图)、`video3`(深度摄像头灰度图)、`video4`(深度摄像头彩图)；加装机械臂后再开机时，以上设备编号各自加 1，变为`video1`至`video5`。这种情况对于编写其他代码会造成比较大的困扰，因此需要按照如下顺序加装机械臂
	1. 先将机械狗开机进入系统
	2. 在`terminal`输入`top`查看当前进程
	3. 使用`sudo kill -9 进程pid号`将上一步中查找到的python进程杀死
	4. 加装机械臂，连接机械臂USB线，将电源线接到12V输出口
	5. 使用`sudo chmod 777 /dev/ttyUSB0`为串口添加权限

	此时我们就可以操控机械臂了
	
3. 使用代码`wheel_arm.py`，即可简单控制机械臂

4. 我们可以进一步自定义机械臂姿态。在文件`utils/ArmController.py`中，可以看到六个舵机各自的ID号，在`def set_pose(self, mode = 0)`中可以修改每一个舵机的开合角度，配合飞特调试软件，即可实现将机械臂控制到自己想要的姿态

>```python
#舵机编号，抓手为1，底盘为6
SCS_ID_1 = 1  # SCServo ID : 1  抓手开合
SCS_ID_2 = 2  # SCServo ID : 2  抓收旋转
SCS_ID_3 = 3  # SCServo ID : 3  第三连杆
SCS_ID_4 = 4  # SCServo ID : 4  第二连杆
SCS_ID_5 = 5  # SCServo ID : 5  第一连杆
SCS_ID_6 = 6  # SCServo ID : 6  控制整个机械臂旋转
>```
>

5. 为了可以准确抓取物体，我们需要采取措施让机械狗知道物体的位置。可以采用aruco码进行简单定位，基本步骤如下
	1. 设置aruco码基本参数
	>```python
	arcode_mode = cv2.aruco.DICT_4X4_50  # 用于定位的ar码的规格
	marker_size = 10  # aruco码的实际尺寸是10厘米
	left_right_thr = 10  # 左右调整位置时，可容忍的偏差 [-thr, thr] 像素
	forward_thr = 30  # 直走时，目标偏差超过thr像素时，开始调整左右位置
	target_id = 1  # 目标ar码的值为多少
	ar_distance = 12 # 距离ar码多少cm时停下
	>```
	>
	2. 捕获视频流，进行相机校准后，使用`cv2.aruco.ArucoDetector()` 函数检测ArUco码的角点，通过`cv2.solvePnP`函数，估算每个ArUco码相对于相机的旋转向量 (rvec) 和平移向量 (tvec)，将这些向量转换为相机坐标系下的位置信息，并计算出每个ArUco码与相机之间的距离。
	3. 根据上一步中的计算结果，对机械狗执行对应操作。

6. 参考代码`chuangyiarm.py`为2024创意大赛四足专项附加赛内容
### 参考
[GitHub](https://github.com/Jadeble/sizutrain)